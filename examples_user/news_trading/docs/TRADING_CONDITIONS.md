# 자동 매매 조건 상세 문서

## 개요

이 문서는 2단계 앙상블 LLM 자동 매매 시스템의 매수/매도 조건을 상세히 설명합니다.

---

## 1. 시그널 체계

### 1.1 시그널 종류

| 시그널 | 점수 | 의미 |
|--------|------|------|
| `STRONG_BUY` | +2 | 강력 매수 - 즉시 진입 권장 |
| `BUY` | +1 | 매수 - 진입 권장 |
| `HOLD` | 0 | 관망 - 현 포지션 유지 |
| `SELL` | -1 | 매도 - 청산 권장 |
| `STRONG_SELL` | -2 | 강력 매도 - 즉시 청산 권장 |

### 1.2 최종 시그널 결정 (앙상블 가중 점수)

```
가중 점수 = Σ(모델별 시그널 점수 × 모델 가중치 × 신뢰도) / 총 가중치
```

| 가중 점수 | 최종 시그널 |
|-----------|-------------|
| >= 1.5 | STRONG_BUY |
| >= 0.5 | BUY |
| <= -1.5 | STRONG_SELL |
| <= -0.5 | SELL |
| 그 외 | HOLD |

---

## 2. 매수 조건

### 2.1 필수 조건 (모두 충족해야 매수)

| 조건 | 기본값 | 설명 |
|------|--------|------|
| **시그널** | `STRONG_BUY` 또는 `BUY` | 앙상블 분석 결과 |
| **신뢰도** | >= 70% | 모델들의 평균 신뢰도 |
| **합의도** | >= 67% | 동일 시그널을 낸 모델 비율 |
| **시장 시간** | 09:00 ~ 15:20 | 장 운영 시간 내 |
| **일일 거래 횟수** | < 10회 | 리스크 관리 |
| **일일 손실 한도** | < 50,000원 | 리스크 관리 |

### 2.2 주문 수량 계산

```python
주문 수량 = 최대 주문 금액 // 현재가
주문 수량 = max(1, 주문 수량)  # 최소 1주
```

- **기본 주문 한도**: 100,000원
- **스캘핑 주문 한도**: 50,000원

### 2.3 매수 흐름도

```
1. 급등 종목 스캔 (SurgeDetector)
   ↓
2. 기술적 지표 분석 (TechnicalAnalyzer)
   - RSI, MACD, 볼린저밴드, VWAP 등
   ↓
3. 1단계: 하위 모델 앙상블 분석
   - DeepSeek-R1 (금융 추론)
   - Qwen3 (한국어 + 범용)
   - Solar (한국어 특화)
   ↓
4. 2단계: 메인 모델 최종 판단
   - EXAONE 4.0 (최종 종합)
   ↓
5. 조건 검증
   - 신뢰도 >= 70%?
   - 합의도 >= 67%?
   - 시그널 = BUY/STRONG_BUY?
   ↓
6. 리스크 검증
   - 일일 거래 횟수 초과?
   - 일일 손실 한도 초과?
   ↓
7. 주문 실행
```

---

## 3. 매도 조건

### 3.1 필수 조건 (모두 충족해야 매도)

| 조건 | 기본값 | 설명 |
|------|--------|------|
| **시그널** | `STRONG_SELL` 또는 `SELL` | 앙상블 분석 결과 |
| **신뢰도** | >= 70% | 모델들의 평균 신뢰도 |
| **합의도** | >= 67% | 동일 시그널을 낸 모델 비율 |
| **보유 수량** | > 0 | 해당 종목 보유 필수 |

### 3.2 매도 수량

```python
매도 수량 = 보유 수량 전량
```

- 부분 매도 미지원 (전량 매도 원칙)

---

## 4. 손절/익절 조건

### 4.1 일반 모드

| 구분 | 비율 | 설명 |
|------|------|------|
| **손절 (Stop Loss)** | -0.5% | 진입가 대비 하락 시 손절 |
| **익절 (Take Profit)** | +1.5% | 진입가 대비 상승 시 익절 |

### 4.2 스캘핑 모드 (09:00 ~ 09:30)

| 구분 | 비율 | 설명 |
|------|------|------|
| **손절 (Stop Loss)** | -0.3% | 타이트한 손절 |
| **익절 (Take Profit)** | +0.8% | 빠른 익절 |

### 4.3 손절/익절 가격 계산

```python
# 매수 시
손절가 = 진입가 × (1 - 손절률)
익절가 = 진입가 × (1 + 익절률)

# 예시: 진입가 100,000원, 손절률 0.5%, 익절률 1.5%
손절가 = 100,000 × 0.995 = 99,500원
익절가 = 100,000 × 1.015 = 101,500원
```

---

## 5. 스캘핑 모드

### 5.1 활성화 조건

| 조건 | 값 |
|------|-----|
| **시간** | 09:00 ~ 09:30 |
| **기능** | 자동 감지 |

### 5.2 스캘핑 전용 설정

| 설정 | 일반 모드 | 스캘핑 모드 |
|------|-----------|-------------|
| 최소 신뢰도 | 70% | **65%** |
| 주문 한도 | 100,000원 | **50,000원** |
| 손절률 | 0.5% | **0.3%** |
| 익절률 | 1.5% | **0.8%** |
| 주문 유형 | 지정가 | **시장가** |

### 5.3 스캘핑 분석 요소

1. **야간 뉴스 분석**
   - 전일 15:30 이후 ~ 금일 09:00 이전 뉴스 수집
   - 호재/악재 비중 평가
   - 갭 상승/하락 예측

2. **장 초반 지표**
   - 체결강도 (100 이상 매수우세)
   - 호가잔량비 (1 이상 매수우세)
   - 급등점수 (50점 이상)

---

## 6. 앙상블 분석 상세

### 6.1 모델 구성

#### 1단계: 하위 모델 (데이터 탐색)

| 모델 | 가중치 | 특징 |
|------|--------|------|
| `deepseek-r1:8b` | 1.2 | 금융 추론 특화 |
| `qwen3:8b` | 1.0 | 한국어 + 범용 |
| `solar:10.7b` | 1.0 | 한국어 특화 |

#### 2단계: 메인 모델 (최종 판단)

| 모델 | 가중치 | 역할 |
|------|--------|------|
| `exaone4.0:32b` | **2.5** | 하위 모델 결과 종합, 최종 판단 |

### 6.2 신뢰도 계산

```python
가중 신뢰도 = Σ(모델별 신뢰도 × 모델 가중치) / Σ(모델 가중치)
```

### 6.3 합의도 계산

```python
합의도 = 가장 많은 시그널을 낸 모델 수 / 전체 성공 모델 수
```

예시:
- 모델 A: BUY
- 모델 B: BUY
- 모델 C: STRONG_BUY
- 메인 모델: BUY

→ BUY = 3개, STRONG_BUY = 1개
→ 합의도 = 3/4 = 75%

---

## 7. 기술적 지표 분석

### 7.1 사용 지표

| 카테고리 | 지표 | 매수 신호 | 매도 신호 |
|----------|------|-----------|-----------|
| **모멘텀** | RSI(14) | < 30 (과매도) | > 70 (과매수) |
| | RSI(7) | < 25 | > 75 |
| | 스토캐스틱 %K | < 20 | > 80 |
| | MACD | 시그널 상향돌파 | 시그널 하향돌파 |
| **밴드** | 볼린저 %B | < 0 (하단 이탈) | > 1 (상단 이탈) |
| | VWAP | 현재가 > VWAP | 현재가 < VWAP |
| **이동평균** | EMA 배열 | EMA5 > EMA20 (정배열) | EMA5 < EMA20 (역배열) |
| **지지/저항** | 피봇 | 지지선 근처 | 저항선 근처 |

### 7.2 종합 점수

```
기술적 점수 범위: -100 ~ +100

+50 이상: 매우 강한 매수 신호
+20 ~ +50: 매수 신호
-20 ~ +20: 중립
-50 ~ -20: 매도 신호
-50 이하: 매우 강한 매도 신호
```

---

## 8. 리스크 관리

### 8.1 일일 제한

| 항목 | 기본값 | 설명 |
|------|--------|------|
| 최대 거래 횟수 | 10회 | 하루 총 매수+매도 횟수 |
| 최대 손실 | 50,000원 | 하루 누적 손실 한도 |

### 8.2 제한 초과 시 동작

- 일일 거래 횟수 초과 → 거래 중단, `SKIP` 반환
- 일일 손실 한도 초과 → 거래 중단, `SKIP` 반환
- 자정 기준 카운터 자동 리셋

### 8.3 시장 시간 체크

| 상황 | 동작 |
|------|------|
| 장 시작 전 (09:00 이전) | 거래 불가, `SKIP` |
| 장 운영 중 (09:00~15:20) | 거래 가능 |
| 장 마감 후 (15:20 이후) | 거래 불가, `SKIP` |
| 주말 (토, 일) | 거래 불가, `SKIP` |

---

## 9. 설정 파일 (config/auto_trade.yaml)

```yaml
# 환경 설정
environment:
  env_dv: "real"              # 실전투자 전용

# 주문 설정
order:
  max_order_amount: 100000    # 1회 주문 한도 (원)
  ord_dvsn: "00"              # "00": 지정가, "01": 시장가

# 신뢰도/합의도 기준
threshold:
  min_confidence: 0.7         # 최소 신뢰도 (70%)
  min_consensus: 0.67         # 최소 합의도 (67%)

# 매매 시그널
signals:
  buy:
    - "STRONG_BUY"
    - "BUY"
  sell:
    - "STRONG_SELL"
    - "SELL"

# 리스크 관리
risk:
  stop_loss_pct: 0.5          # 손절률 (%)
  take_profit_pct: 1.5        # 익절률 (%)
  max_daily_trades: 10        # 일일 최대 거래 횟수
  max_daily_loss: 50000       # 일일 최대 손실 (원)

# 급등 종목 스캔
scan:
  min_surge_score: 50.0       # 최소 급등 점수 (0~100)
  max_stocks_per_scan: 5      # 스캔당 분석할 최대 종목 수

# 스캘핑 모드 (09:00~09:30)
scalping:
  enabled: true
  min_confidence: 0.65        # 스캘핑 최소 신뢰도
  max_order_amount: 50000     # 스캘핑 주문 한도
  stop_loss_pct: 0.3          # 스캘핑 손절률
  take_profit_pct: 0.8        # 스캘핑 익절률
```

---

## 10. 주문 실행 흐름

### 10.1 매수 주문

```
1. execute_auto_trade() 호출
   ↓
2. 시그널 확인: BUY 또는 STRONG_BUY?
   → 아니면 SKIP
   ↓
3. 신뢰도 확인: >= 70%?
   → 아니면 SKIP (사유: 신뢰도 부족)
   ↓
4. 합의도 확인: >= 67%?
   → 아니면 SKIP (사유: 합의도 부족)
   ↓
5. 주문 수량 계산
   수량 = 주문한도 // 현재가
   ↓
6. 주문 금액 한도 확인
   → 초과 시 수량 조정
   ↓
7. KIS API order_cash() 호출
   ↓
8. 결과 반환 (OrderResult)
```

### 10.2 매도 주문

```
1. execute_auto_trade() 호출
   ↓
2. 시그널 확인: SELL 또는 STRONG_SELL?
   → 아니면 SKIP
   ↓
3. 신뢰도/합의도 확인
   ↓
4. 보유 수량 확인: > 0?
   → 아니면 SKIP (사유: 보유 수량 없음)
   ↓
5. 매도 수량 = 보유 전량
   ↓
6. KIS API order_cash() 호출
   ↓
7. 결과 반환 (OrderResult)
```

---

## 11. 결과 코드

### 11.1 action 필드 값

| 값 | 의미 |
|----|------|
| `BUY` | 매수 실행됨 |
| `SELL` | 매도 실행됨 |
| `HOLD` | HOLD 시그널 - 주문 없음 |
| `SKIP` | 조건 미충족 - 주문 스킵 |
| `ERROR` | 오류 발생 |

### 11.2 실패 사유 (reason 필드)

| 사유 | 설명 |
|------|------|
| `신뢰도 부족: X% < Y%` | 신뢰도가 기준 미달 |
| `합의도 부족: X% < Y%` | 합의도가 기준 미달 |
| `보유 수량 없음 - 매도 불가` | 해당 종목 미보유 |
| `HOLD 시그널 - 주문 없음` | 관망 판단 |
| `허용되지 않은 시그널: X` | 설정에 없는 시그널 |
| `주문 한도 초과` | 가격이 1회 한도 초과 |
| `일일 거래 횟수 초과` | 10회 초과 |
| `일일 손실 한도 초과` | 5만원 초과 |
| `장 시작 전 / 장 마감 후` | 거래 시간 외 |
| `주말은 거래 불가` | 토/일요일 |

---

## 부록: 급등 종목 탐지 조건

### 급등 점수 (surge_score) 계산 요소

| 요소 | 가중치 | 설명 |
|------|--------|------|
| 등락률 | 30% | 전일 대비 상승률 |
| 체결강도 | 25% | 매수/매도 체결 비율 (100 기준) |
| 거래량 증가율 | 25% | 전일 대비 거래량 증가 |
| 호가잔량비 | 20% | 매수/매도 호가 잔량 비율 |

### 급등 후보 필터링

```
급등 점수 >= 50점: 분석 대상
급등 점수 >= 70점: 우선 분석 대상
```

---

*문서 버전: 1.0*
*최종 수정: 2024-12*
